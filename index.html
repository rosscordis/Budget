<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Budget and Finance Planner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js for visual spending breakdown -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Base styles for a clean, modern look, inspired by the provided image */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #F0F4F8; /* Lighter, soft background from image */
            color: #334155; /* Darker text for readability */
            padding: 20px;
            line-height: 1.6;
        }
        .container {
            max-width: 900px;
            margin: 20px auto;
            background-color: #ffffff;
            border-radius: 20px; /* Consistent rounded corners */
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08); /* Softer, more pronounced shadow */
            padding: 40px; /* More internal padding */
            box-sizing: border-box;
        }
        h1 {
            color: #4C51BF; /* Deeper purple-blue for main title */
            font-weight: 800; /* Bolder title */
            margin-bottom: 30px;
            text-align: center;
            font-size: 2.5em;
            letter-spacing: -0.02em;
        }
        h2 {
            color: #6B7280; /* Muted gray for section titles */
            font-weight: 700;
            margin-bottom: 25px;
            text-align: center;
            font-size: 1.8em;
        }
        /* Input group styling */
        .input-group {
            margin-bottom: 20px;
        }
        .input-group label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: #4B5563; /* Slightly darker gray for labels */
            font-size: 1.05em;
        }
        .input-group input[type="number"],
        .input-group input[type="text"],
        .input-group select {
            width: 100%;
            padding: 14px 18px; /* Larger padding for inputs */
            border: 1px solid #D1D5DB; /* Lighter border */
            border-radius: 12px; /* More rounded inputs */
            font-size: 17px;
            box-sizing: border-box;
            transition: all 0.3s ease; /* Smooth transitions */
            background-color: #F9FAFB; /* Very light background for inputs */
            color: #334155;
        }
        .input-group input[type="number"]:focus,
        .input-group input[type="text"]:focus,
        .input-group select:focus {
            outline: none;
            border-color: #8B5CF6; /* Purple on focus */
            box-shadow: 0 0 0 4px rgba(139, 92, 246, 0.2); /* Softer focus shadow */
            background-color: #ffffff;
        }
        /* Section card styling */
        .section-card {
            background-color: #ffffff; /* White background for cards */
            border-radius: 16px; /* Consistent rounded corners */
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.06); /* Subtle card shadow */
        }
        .section-card h3 {
            font-weight: 600;
            color: #6B7280;
            margin-bottom: 20px;
            font-size: 1.3em;
            text-align: center;
        }
        /* Allocation items */
        .allocation-item {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px dashed #E5E7EB; /* Softer dashed line */
            font-size: 1.1em;
            color: #4B5563;
        }
        .allocation-item:last-child {
            border-bottom: none;
        }
        .allocation-item span:first-child {
            font-weight: 500;
            color: #6B7280;
        }
        .currency-value {
            font-weight: 700;
            color: #4C51BF; /* Consistent with main title accent */
        }
        /* Table styling */
        .spending-table {
            width: 100%;
            border-collapse: separate; /* Allows for border-radius on cells */
            border-spacing: 0 10px; /* Space between rows */
            margin-top: 25px;
        }
        .spending-table th, .spending-table td {
            padding: 15px;
            text-align: left;
            background-color: #ffffff; /* White background for table cells */
            border-bottom: 1px solid #E5E7EB;
        }
        .spending-table th {
            background-color: #F3F4F6; /* Lighter gray for table headers */
            font-weight: 600;
            color: #4B5563;
            position: sticky;
            top: 0;
            z-index: 1;
        }
        .spending-table thead tr:first-child th:first-child {
            border-top-left-radius: 10px;
        }
        .spending-table thead tr:first-child th:last-child {
            border-top-right-radius: 10px;
        }
        .spending-table tbody tr {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.03); /* Subtle shadow for rows */
            border-radius: 10px;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .spending-table tbody tr:hover {
            transform: translateY(-2px);
            box-shadow: 0 4-px 12px rgba(0, 0, 0, 0.08);
        }
        .spending-table tbody tr td:first-child {
            border-bottom-left-radius: 10px;
            border-top-left-radius: 10px;
        }
        .spending-table tbody tr td:last-child {
            border-bottom-right-radius: 10px;
            border-top-right-radius: 10px;
        }
        .spending-table input[type="text"],
        .spending-table input[type="number"],
        .spending-table select {
            width: calc(100% - 10px);
            padding: 10px 12px;
            border: 1px solid #D1D5DB;
            border-radius: 8px;
            font-size: 15px;
            box-sizing: border-box;
            background-color: #F9FAFB;
        }
        /* Action buttons */
        .action-buttons {
            display: flex;
            flex-wrap: wrap;
            justify-content: center; /* Changed from flex-start to center */
            gap: 12px; /* Increased gap */
            margin-top: 25px;
        }
        .add-row-btn, .export-btn, .print-btn, .clear-all-btn {
            background-color: #8B5CF6; /* Purple for primary actions */
            color: white;
            padding: 12px 20px; /* Larger padding */
            border: none;
            border-radius: 10px; /* Consistent rounded corners */
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: background-color 0.2s, transform 0.1s, box-shadow 0.2s;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        .add-row-btn:hover, .export-btn:hover, .print-btn:hover, .clear-all-btn:hover {
            background-color: #7C3AED; /* Slightly darker purple on hover */
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }
        .remove-row-btn {
            background-color: #EF4444; /* Red for remove actions */
            padding: 8px 12px;
            border-radius: 8px; /* Slightly less rounded than main buttons */
            font-size: 14px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            display: flex; /* Use flex to center icon */
            justify-content: center;
            align-items: center;
            width: 36px; /* Fixed width for icon button */
            height: 36px; /* Fixed height for icon button */
            margin-left: auto; /* Push to right on desktop */
        }
        .remove-row-btn:hover {
            background-color: #DC2626;
            transform: translateY(-1px);
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.15);
        }
        .clear-all-btn {
            background-color: #EF4444; /* Red for destructive action */
        }
        .clear-all-btn:hover {
            background-color: #DC2626;
        }
        /* Summary items */
        .summary-item {
            display: flex;
            justify-content: space-between;
            padding: 15px 0;
            font-size: 1.15em;
            font-weight: 600;
            color: #334155;
            transition: color 0.3s ease; /* Only transition color */
        }
        /* Specific rules for the main balance summary item */
        .summary-item.balance {
            border-top: 2px solid #E5E7EB; /* Softer border for balance */
            margin-top: 20px;
            padding-top: 20px;
            font-size: 1.25em;
            font-weight: 700;
            /* Ensure no background color is set here */
        }
        /* Text color for the main balance based on status */
        .summary-item.balance .currency-value.overspend {
            color: #EF4444; /* Red text for overspend */
        }
        .summary-item.balance .currency-value.underspend {
            color: #10B981; /* Green text for underspend */
        }


        /* New background colors for summary status boxes (Needs, Wants, Savings & Debt) */
        .status-box.overspend {
            background-color: #FEE2E2; /* Light red background */
        }
        .status-box.underspend {
            background-color: #D1FAE5; /* Light green background */
        }
        /* Ensure text color within status boxes remains default */
        .status-box h3, .status-box .currency-value {
            color: inherit; /* Inherit color from parent or default */
        }


        /* Chart container styling for bar chart */
        .chart-container {
            width: 100%;
            max-width: 600px; /* Adjusted max-width for bar chart */
            height: 300px; /* Set a fixed height for the bar chart */
            margin: 25px auto;
            background-color: #ffffff;
            border-radius: 16px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.06);
            padding: 20px;
            display: flex; /* Use flexbox to center content */
            justify-content: center;
            align-items: center;
        }

        /* Responsive adjustments */
        @media (max-width: 600px) {
            .container {
                padding: 15px; /* Slightly less padding on very small screens */
            }
            h1 {
                font-size: 2em;
                margin-bottom: 20px;
            }
            h2 {
                font-size: 1.5em;
                margin-bottom: 20px;
            }
            .input-group label {
                font-size: 1em;
            }
            .input-group input[type="number"],
            .input-group input[type="text"],
            .input-group select {
                padding: 12px 15px; /* Slightly smaller padding for inputs */
                font-size: 16px;
            }

            /* Table specific mobile styles */
            .spending-table {
                border-spacing: 0; /* Remove spacing between rows */
            }
            .spending-table thead {
                display: none; /* Hide table headers on mobile */
            }
            .spending-table tbody tr {
                display: block; /* Make each row a block element */
                margin-bottom: 15px; /* Space between stacked rows */
                border: 1px solid #E5E7EB;
                padding: 10px;
                border-radius: 10px;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.03);
            }
            .spending-table tbody tr:hover {
                transform: none; /* Disable hover transform for mobile rows */
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.03);
            }
            .spending-table tbody td {
                display: block; /* Make each cell a block element */
                text-align: right; /* Align content to the right */
                padding: 8px 10px; /* Adjust cell padding */
                position: relative;
                border-bottom: 1px dashed #E5E7EB; /* Add dashed line between stacked cells */
            }
            .spending-table tbody td:last-child {
                border-bottom: none; /* No border for the last cell in a row */
            }
            .spending-table input[type="text"],
            .spending-table input[type="number"],
            .spending-table select {
                width: 100%; /* Full width for inputs within mobile cells */
                padding: 8px 10px;
                font-size: 14px;
            }

            /* Adjust remove button for mobile */
            .remove-row-btn {
                margin-top: 10px; /* Space from other inputs in mobile row */
                width: 32px; /* Smaller width for icon button */
                height: 32px; /* Smaller height for icon button */
                padding: 0; /* Remove padding */
                font-size: 14px; /* Adjust icon size */
                margin-left: 0; /* Remove auto margin */
            }
            .remove-row-btn i {
                font-size: 14px; /* Explicit icon size */
            }

            .action-buttons {
                flex-direction: column;
                align-items: stretch;
                gap: 10px;
            }
            .add-row-btn, .export-btn, .print-btn, .clear-all-btn {
                padding: 10px 15px;
                font-size: 15px;
            }
            .summary-item {
                font-size: 1em;
            }
            .summary-item.balance {
                font-size: 1.1em;
            }
        }
        @media print {
            body * {
                visibility: hidden;
            }
            .container, .container * {
                visibility: visible;
            }
            .container {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                box-shadow: none;
                border: none;
                margin: 0;
                padding: 0;
            }
            .action-buttons, .remove-row-btn, .input-group input, .input-group select, .clear-all-btn {
                display: none;
            }
            .spending-table input[type="text"], .spending-table input[type="number"], .spending-table select {
                border: none;
                width: auto;
                padding: 0;
            }
            .spending-table td {
                padding: 5px;
            }
            .chart-container {
                display: block !important;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Budget and Finance Planner</h1>

        <div class="section-card">
            <h2>Income Details</h2>
            <div class="input-group">
                <label for="incomeInput">Income (£):</label>
                <input type="number" id="incomeInput" placeholder="e.g., 2500" min="0">
            </div>
        </div>

        <div class="section-card">
            <h2>Spending Categories</h2>
            <table class="spending-table" id="spendingTable">
                <thead>
                    <tr>
                        <th>Category</th>
                        <th>Actual Spend (£)</th>
                        <th>Type</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Dynamic rows will be added here -->
                </tbody>
            </table>
            <div class="action-buttons">
                <button id="addRowBtn" class="add-row-btn">Add New Category</button>
                <button id="exportCsvBtn" class="export-btn">Export to CSV</button>
                <button id="printBtn" class="print-btn">Print Budget</button>
                <button id="clearAllDataBtn" class="clear-all-btn">Clear All Data</button>
            </div>
        </div>

        <div class="section-card">
            <h2>Visual Spending Breakdown</h2>
            <div class="chart-container">
                <canvas id="spendingChart"></canvas>
            </div>
        </div>

        <div class="section-card">
            <h2>Summary</h2>
            <div class="summary-item" id="overallSummaryItem">
                <span>Total Actual Spending:</span>
                <span id="totalActualSpending" class="currency-value">£0.00</span>
            </div>
            <div class="summary-item balance" id="balanceSummaryItem">
                <span>Remaining:</span>
                <span id="balanceStatus" class="currency-value">£0.00</span>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-5">
                <div id="needsStatusDiv" class="text-center p-3 rounded-lg bg-gray-50 status-box">
                    <h3 class="font-semibold text-gray-700 mb-1">Needs</h3>
                    <span id="needsStatus" class="currency-value text-lg">£0.00</span>
                </div>
                <div id="wantsStatusDiv" class="text-center p-3 rounded-lg bg-gray-50 status-box">
                    <h3 class="font-semibold text-gray-700 mb-1">Wants</h3>
                    <span id="wantsStatus" class="currency-value text-lg">£0.00</span>
                </div>
                <div id="savingsDebtStatusDiv" class="text-center p-3 rounded-lg bg-gray-50 status-box">
                    <h3 class="font-semibold text-gray-700 mb-1">Savings & Debt</h3>
                    <span id="savingsDebtStatus" class="currency-value text-lg">£0.00</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Get DOM elements
        const incomeInput = document.getElementById('incomeInput');
        const spendingTableBody = document.querySelector('#spendingTable tbody');
        const addRowBtn = document.getElementById('addRowBtn');
        const exportCsvBtn = document.getElementById('exportCsvBtn');
        const printBtn = document.getElementById('printBtn');
        const clearAllDataBtn = document.getElementById('clearAllDataBtn');
        const totalActualSpendingSpan = document.getElementById('totalActualSpending');
        const balanceStatusSpan = document.getElementById('balanceStatus');
        const needsStatusSpan = document.getElementById('needsStatus');
        const wantsStatusSpan = document.getElementById('wantsStatus');
        const savingsDebtStatusSpan = document.getElementById('savingsDebtStatus');

        const needsStatusDiv = document.getElementById('needsStatusDiv');
        const wantsStatusDiv = document.getElementById('wantsStatusDiv');
        const savingsDebtStatusDiv = document.getElementById('savingsDebtStatusDiv');
        const balanceSummaryItem = document.getElementById('balanceSummaryItem');


        let spendingCategories = [];

        let spendingChart;

        // Function to format currency
        const formatCurrency = (value) => `£${value.toFixed(2)}`;

        // Function to display alerts (now empty as alerts are removed)
        const showAlert = (message, type = 'warning') => {
            // No longer displaying alerts
        };

        // Function to calculate 50/30/20 allocation
        const calculateAllocation = () => {
            const income = parseFloat(incomeInput.value) || 0;

            const needs = income * 0.50;
            const wants = income * 0.30;
            const savingsDebt = income * 0.20;
            const totalAllocated = needs + wants + savingsDebt;

            return { needs, wants, savingsDebt, totalAllocated };
        };

        // Function to render spending categories
        const renderSpendingCategories = () => {
            spendingTableBody.innerHTML = ''; // Clear existing rows

            // Define the number of initial default categories
            const numberOfDefaultCategories = 7;

            spendingCategories.forEach((item, index) => {
                const row = spendingTableBody.insertRow();
                const typeSelectId = `type-select-${index}`; // Unique ID for type select

                // Options for the Type dropdown
                const typeOptionsHtml = `
                    <option value="needs" ${item.type === 'needs' ? 'selected' : ''}>Needs</option>
                    <option value="wants" ${item.type === 'wants' ? 'selected' : ''}>Wants</option>
                    <option value="savingsDebt" ${item.type === 'savingsDebt' ? 'selected' : ''}>Savings/Debt</option>
                `;

                // Determine the value for the amount input: empty string if 0, otherwise the actual amount
                const amountValue = (item.amount === 0) ? '' : item.amount;

                // Conditionally render the 'Type' column
                let typeColumnHtml;
                if (index < numberOfDefaultCategories) {
                    // For default categories, show plain text
                    typeColumnHtml = `<td data-label="Type" class="font-semibold text-gray-600">${item.type.charAt(0).toUpperCase() + item.type.slice(1)}</td>`;
                } else {
                    // For additional categories, show the select dropdown
                    typeColumnHtml = `
                        <td data-label="Type">
                            <select id="${typeSelectId}" data-index="${index}" data-field="type" class="rounded-md p-2 border border-gray-300 mb-2">
                                ${typeOptionsHtml}
                            </select>
                        </td>
                    `;
                }

                row.innerHTML = `
                    <td data-label="Category"><input type="text" value="${item.category}" data-index="${index}" data-field="category" class="rounded-md"></td>
                    <td data-label="Actual Spend (£)"><input type="number" value="${amountValue}" placeholder="0" data-index="${index}" data-field="amount" class="rounded-md"></td>
                    ${typeColumnHtml}
                    <td data-label="Action">
                        <button class="remove-row-btn rounded-md" data-index="${index}"><i class="fas fa-trash-alt"></i></button>
                    </td>
                `;

                // Add event listeners for the dynamically created selects, only if they exist
                if (index >= numberOfDefaultCategories) {
                    row.querySelector(`#${typeSelectId}`).addEventListener('change', (e) => {
                        updateSpendingData(index, 'type', e.target.value);
                    });
                }
            });
            updateSummary(); // Update summary after rendering
        };

        // Function to update spending category data
        const updateSpendingData = (index, field, value) => {
            if (field === 'amount') {
                // Attempt to parse the value as a float, default to 0 if not a valid number
                spendingCategories[index][field] = parseFloat(value) || 0;
            } else {
                spendingCategories[index][field] = value;
            }
            updateSummary();
            saveCurrentState(); // Save data after every change
        };

        // Function to add a new spending category row
        const addSpendingCategoryRow = () => {
            spendingCategories.push({ category: '', amount: 0, type: 'general' });
            renderSpendingCategories();
            saveCurrentState();
        };

        // Function to remove a spending category row
        const removeSpendingCategoryRow = (indexToRemove) => {
            spendingCategories.splice(indexToRemove, 1);
            renderSpendingCategories(); // Re-render to update indices
            saveCurrentState();
        };

        // Function to update the summary section and charts
        const updateSummary = () => {
            const { needs, wants, savingsDebt, totalAllocated } = calculateAllocation();

            let totalActual = 0;
            let actualNeeds = 0;
            let actualWants = 0;
            let actualSavingsDebt = 0;

            const chartLabels = [];
            const chartData = [];
            const chartColors = [];

            // Define a consistent color palette for chart based on Material You feel
            const materialColors = {
                needs: '#60A5FA', /* Blue-500 */
                wants: '#FCD34D', /* Amber-400 */
                savingsDebt: '#34D399', /* Emerald-400 */
                other: '#9CA3AF' /* Gray-400 */
            };

            // Group spending by category for the bar chart
            const categorySpending = {};
            // Also keep track of the type for each category for coloring
            const categoryTypes = {};

            spendingCategories.forEach(item => {
                const amount = parseFloat(item.amount) || 0;
                totalActual += amount;
                
                // Map categories to types for allocation calculation
                let itemTypeForAllocation;
                if (['Car', 'Groceries', 'Transport'].includes(item.category)) {
                    itemTypeForAllocation = 'needs';
                } else if (['Shopping', 'Subscriptions', 'General'].includes(item.category)) {
                    itemTypeForAllocation = 'wants';
                } else if (item.category === 'Finances') {
                    itemTypeForAllocation = 'savingsDebt';
                } else {
                    itemTypeForAllocation = item.type; // Fallback to assigned type if not a default category
                }

                if (itemTypeForAllocation === 'needs') {
                    actualNeeds += amount;
                } else if (itemTypeForAllocation === 'wants') {
                    actualWants += amount;
                } else if (itemTypeForAllocation === 'savingsDebt') {
                    actualSavingsDebt += amount;
                }

                // For bar chart, group by category and store its type
                if (item.category) {
                    categorySpending[item.category] = (categorySpending[item.category] || 0) + amount;
                    categoryTypes[item.category] = itemTypeForAllocation; // Store the type for coloring
                }
            });

            // Prepare data for bar chart
            for (const category in categorySpending) {
                if (categorySpending[category] > 0) {
                    chartLabels.push(category);
                    chartData.push(categorySpending[category]);
                    // Assign colors based on the category's type
                    chartColors.push(materialColors[categoryTypes[category]] || materialColors.other);
                }
            }


            totalActualSpendingSpan.textContent = formatCurrency(totalActual);

            const overallBalance = totalAllocated - totalActual;
            
            // Remove existing text color classes from the balance status span
            balanceStatusSpan.classList.remove('overspend', 'underspend');

            if (overallBalance < 0) {
                balanceStatusSpan.textContent = `Over by ${formatCurrency(Math.abs(overallBalance))}`;
                balanceStatusSpan.classList.add('overspend'); // Apply red text color
            } else {
                balanceStatusSpan.textContent = formatCurrency(overallBalance);
                if (overallBalance > 0) {
                    balanceStatusSpan.classList.add('underspend'); // Apply green text color
                }
            }


            // Update status for each category type for the condensed summary
            const updateCategoryStatus = (allocated, actual, statusSpan, parentDiv, isSavings = false) => {
                const diff = allocated - actual;
                statusSpan.textContent = formatCurrency(actual); // Only show actual amount

                // Remove existing background classes from the parentDiv
                parentDiv.classList.remove('overspend', 'underspend'); /* Remove old classes */
                parentDiv.classList.add('bg-gray-50'); // Reset to default background

                if (isSavings) {
                    if (diff > 0) { // Actual < Allocated (undersaved) -> Red background
                        parentDiv.classList.add('overspend');
                    } else if (diff < 0) { // Actual > Allocated (oversaved) -> Green background
                        parentDiv.classList.add('underspend');
                    }
                } else { // For Needs and Wants
                    if (diff < 0) { // Actual > Allocated (overspent) -> Red background
                        parentDiv.classList.add('overspend');
                    } else if (diff > 0) { // Actual < Allocated (underspent) -> Green background
                        parentDiv.classList.add('underspend');
                    }
                }
            };

            updateCategoryStatus(needs, actualNeeds, needsStatusSpan, needsStatusDiv, false);
            updateCategoryStatus(wants, actualWants, wantsStatusSpan, wantsStatusDiv, false);
            updateCategoryStatus(savingsDebt, actualSavingsDebt, savingsDebtStatusSpan, savingsDebtStatusDiv, true);
        
            // Update Chart
            if (spendingChart) {
                spendingChart.data.labels = chartLabels;
                spendingChart.data.datasets[0].data = chartData;
                spendingChart.data.datasets[0].backgroundColor = chartColors;
                spendingChart.data.datasets[0].borderColor = 'transparent';
                spendingChart.update();
            } else {
                const ctx = document.getElementById('spendingChart').getContext('2d');
                spendingChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: chartLabels,
                        datasets: [{
                            label: 'Amount Spent (£)',
                            data: chartData,
                            backgroundColor: chartColors,
                            borderColor: 'transparent',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false,
                            },
                            tooltip: {
                                intersect: false,
                                callbacks: {
                                    label: function(context) {
                                        let label = context.dataset.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        if (context.parsed.y !== null) {
                                            label += formatCurrency(context.parsed.y);
                                        }
                                        return label;
                                    }
                                },
                                titleFont: {
                                    family: 'Inter'
                                },
                                bodyFont: {
                                    family: 'Inter'
                                }
                            }
                        },
                        scales: {
                            x: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Category',
                                    font: {
                                        family: 'Inter',
                                        size: 14
                                    },
                                    color: '#4B5563'
                                },
                                ticks: {
                                    font: {
                                        family: 'Inter'
                                    },
                                    color: '#6B7280'
                                }
                            },
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Money Spent (£)',
                                    font: {
                                        family: 'Inter',
                                        size: 14
                                    },
                                    color: '#4B5563'
                                },
                                ticks: {
                                    callback: function(value) {
                                        return formatCurrency(value);
                                    },
                                    font: {
                                        family: 'Inter'
                                    },
                                    color: '#6B7280'
                                }
                            }
                        }
                    }
                });
            }
        };

        // --- Local Storage Functions ---
        const LOCAL_STORAGE_KEY = 'budgetPlannerDataV2';

        const saveCurrentState = () => {
            const dataToSave = {
                income: incomeInput.value,
                spendingCategories: spendingCategories
            };
            localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(dataToSave));
            console.log('Current budget data saved to local storage.');
        };

        const loadCurrentState = () => {
            const savedData = localStorage.getItem(LOCAL_STORAGE_KEY);
            if (savedData) {
                const parsedData = JSON.parse(savedData);
                incomeInput.value = parsedData.income || parsedData.takeHomePay || '';
                spendingCategories = parsedData.spendingCategories || [];
                spendingCategories.forEach(item => {
                    delete item.recurring;
                    delete item.linkedGoalId;
                });
                console.log('Current budget data loaded from local storage.');
            } else {
                spendingCategories = [
                    { category: 'Car', amount: 0, type: 'needs' },
                    { category: 'Groceries', amount: 0, type: 'needs' },
                    { category: 'Transport', amount: 0, type: 'needs' },
                    { category: 'Shopping', amount: 0, type: 'wants' },
                    { category: 'Subscriptions', amount: 0, type: 'wants' },
                    { category: 'General', amount: 0, type: 'wants' },
                    { category: 'Finances', amount: 0, type: 'savingsDebt' }
                ];
            }
        };

        // Function to clear all local storage data for the app
        const clearAllData = () => {
            const userConfirmed = window.confirm('Are you sure you want to clear ALL data? This action cannot be undone.');

            if (userConfirmed) {
                localStorage.removeItem(LOCAL_STORAGE_KEY);
                incomeInput.value = '';
                spendingCategories = [
                    { category: 'Car', amount: 0, type: 'needs' },
                    { category: 'Groceries', amount: 0, type: 'needs' },
                    { category: 'Transport', amount: 0, type: 'needs' },
                    { category: 'Shopping', amount: 0, type: 'wants' },
                    { category: 'Subscriptions', amount: 0, type: 'wants' },
                    { category: 'General', amount: 0, type: 'wants' },
                    { category: 'Finances', amount: 0, type: 'savingsDebt' }
                ];
                renderSpendingCategories();
                updateSummary();
            }
        };


        // --- Export to CSV Function ---
        const exportToCsv = () => {
            const { needs, wants, savingsDebt } = calculateAllocation();
            const income = parseFloat(incomeInput.value) || 0;

            let csvContent = "data:text/csv;charset=utf-8,";

            csvContent += "Income Details\n";
            csvContent += "Monthly Income\n";
            csvContent += `${income.toFixed(2)}\n\n`;

            csvContent += "50/30/20 Rule Allocation (Calculated)\n";
            csvContent += `Needs (50%),${needs.toFixed(2)}\n`;
            csvContent += `Wants (30%),${wants.toFixed(2)}\n`;
            csvContent += `Savings & Debt (20%),${savingsDebt.toFixed(2)}\n\n`;

            csvContent += "Spending Categories\n";
            csvContent += "Category,Actual Spend,Type\n";
            spendingCategories.forEach(item => {
                csvContent += `${item.category},${item.amount.toFixed(2)},${item.type}\n`;
            });
            csvContent += "\n";

            let totalActual = 0;
            spendingCategories.forEach(item => totalActual += (parseFloat(item.amount) || 0));
            const overallBalance = income - totalActual;

            csvContent += "Summary\n";
            csvContent += "Item,Value\n";
            csvContent += `Total Actual Spending,${totalActual.toFixed(2)}\n`;
            csvContent += `Remaining/Overspent,${overallBalance.toFixed(2)}\n`;
            csvContent += `Needs Actual,${spendingCategories.filter(cat => {
                let itemTypeForAllocation;
                if (['Car', 'Groceries', 'Transport'].includes(cat.category)) {
                    itemTypeForAllocation = 'needs';
                } else if (['Shopping', 'Subscriptions', 'General'].includes(cat.category)) {
                    itemTypeForAllocation = 'wants';
                } else if (cat.category === 'Finances') {
                    itemTypeForAllocation = 'savingsDebt';
                } else {
                    itemTypeForAllocation = cat.type;
                }
                return itemTypeForAllocation === 'needs';
            }).reduce((sum, cat) => sum + (parseFloat(cat.amount) || 0), 0).toFixed(2)}\n`;
            csvContent += `Wants Actual,${spendingCategories.filter(cat => {
                let itemTypeForAllocation;
                if (['Car', 'Groceries', 'Transport'].includes(cat.category)) {
                    itemTypeForAllocation = 'needs';
                } else if (['Shopping', 'Subscriptions', 'General'].includes(cat.category)) {
                    itemTypeForAllocation = 'wants';
                } else if (cat.category === 'Finances') {
                    itemTypeForAllocation = 'savingsDebt';
                } else {
                    itemTypeForAllocation = cat.type;
                }
                return itemTypeForAllocation === 'wants';
            }).reduce((sum, cat) => sum + (parseFloat(cat.amount) || 0), 0).toFixed(2)}\n`;
            csvContent += `Savings & Debt Actual,${spendingCategories.filter(cat => {
                let itemTypeForAllocation;
                if (['Car', 'Groceries', 'Transport'].includes(cat.category)) {
                    itemTypeForAllocation = 'needs';
                } else if (['Shopping', 'Subscriptions', 'General'].includes(cat.category)) {
                    itemTypeForAllocation = 'wants';
                } else if (cat.category === 'Finances') {
                    itemTypeForAllocation = 'savingsDebt';
                } else {
                    itemTypeForAllocation = cat.type;
                }
                return itemTypeForAllocation === 'savingsDebt';
            }).reduce((sum, cat) => sum + (parseFloat(cat.amount) || 0), 0).toFixed(2)}\n`;


            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "budget_planner.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };

        // --- Event Listeners ---
        incomeInput.addEventListener('input', () => {
            saveCurrentState();
            updateSummary();
        });
        addRowBtn.addEventListener('click', addSpendingCategoryRow);
        exportCsvBtn.addEventListener('click', exportToCsv);
        printBtn.addEventListener('click', () => window.print());
        clearAllDataBtn.addEventListener('click', clearAllData);

        // Event delegation for dynamically added spending rows
        spendingTableBody.addEventListener('input', (event) => {
            const target = event.target;
            const index = parseInt(target.dataset.index);
            const field = target.dataset.field;
            if (!isNaN(index) && field) {
                updateSpendingData(index, field, target.value);
            }
        });
        spendingTableBody.addEventListener('change', (event) => {
            const target = event.target;
            const index = parseInt(target.dataset.index);
            const field = target.dataset.field;
            if (!isNaN(index) && field) {
                updateSpendingData(index, field, target.value);
            }
        });

        spendingTableBody.addEventListener('click', (event) => {
            const target = event.target;
            if (target.classList.contains('remove-row-btn')) {
                const index = parseInt(target.dataset.index);
                if (!isNaN(index)) {
                    removeSpendingCategoryRow(index);
                }
            }
        });

        // Initial load and render
        loadCurrentState();
        renderSpendingCategories();
        updateSummary();
    </script>
</body>
</html>
